var app = getApp();
Page({
  
  data: {
    myorder: 'https://iservice.daqisoft.cn/Public/Home/images/amimgs/myorder.png',
    my: "我的订单",
    mode:'aspectFit',
    bespeak:'预约',
    addrimg: 'https://iservice.daqisoft.cn/Public/Home/images/amimgs/addr.png',
    searchimg: 'https://iservice.daqisoft.cn/Public/Home/images/amimgs/search.png',
    noticeimg: 'https://iservice.daqisoft.cn/Public/Home/images/amimgs/msg.png',
    text: '消费主项目才享受优惠商品，未消费不享受这样的优惠啊',
    cartimg: 'https://iservice.daqisoft.cn/Public/Home/images/amimgs/cart.png',
    warnimg: 'https://iservice.daqisoft.cn/Public/Home/images/amimgs/warn.png',
    addr: '2号SPA房',
    addimg: 'https://iservice.daqisoft.cn/Public/Home/images/amimgs/add.png',
    reduceimg: 'https://iservice.daqisoft.cn/Public/Home/images/amimgs/reduce.png',
    clearimg: 'https://iservice.daqisoft.cn/Public/Home/images/amimgs/clear.png',
    classifySeleted:'tj',
    goods:{
        1:{
          id:1,
          name:'红烧肉',
          pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
          desc: '超级好吃的毛氏红烧肉1111111111111111111',
          price:16,
          oldprice:22,
          limit:5,
          ordernum:0,
        },
        2: {
          id: 2,
          name: '红烧牛肉面',
          pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
          desc: '超级好吃的毛氏红烧肉',
          price: 16,
          oldprice: 22,
          limit: 5,
          size: false,
        },
        3: {
          id: 3,
          name: '香菇鸡面',
          pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
          desc: '超级好吃的毛氏红烧肉',
          price: 10,
          oldprice: 18,
          limit: 5,
          ordernum: 0,
        },
        4: {
          id: 4,
          name: '三椒牛肉饭',
          pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
          desc: '超级好吃的毛氏红烧肉',
          price: 30,
          oldprice: 42,
          limit: 5,
          ordernum: 0,
        },
        5: {
          id: 5,
          name: '卤水双拼饭',
          pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
          desc: '超级好吃的毛氏红烧肉',
          price: 30,
          oldprice: 42,
          limit: 5,
          ordernum: 0,
        },
        6: {
          id: 6,
          name: '甘蔗',
          pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
          desc: '超级好吃的甘蔗',
          price: 0,
          oldprice: 22,
          limit: 8,
          ordernum: 0,
        },
        7: {
          id: 7,
          name: '苹果',
          pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
          desc: '超级好吃的甘蔗',
          price: 0,
          oldprice: 22,
          limit: 5,
          ordernum: 0,
        },
        8: {
          id: 8,
          name: '香蕉',
          pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
          desc: '超级好吃的甘蔗',
          price: 0,
          oldprice: 22,
          limit: 5,
          ordernum: 0,
        },
        9: {
          id: 9,
          name: '牛油果',
          pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
          desc: '超级好吃的甘蔗',
          price: 0,
          oldprice: 22,
          limit: 5,
          ordernum: 0,
        },
        10: {
          id: 10,
          name: '菠萝蜜',
          pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
          desc: '超级好吃的甘蔗',
          price: 0,
          oldprice: 22,
          limit: 5,
          ordernum: 0,
        },
        11: {
          id: 11,
          name: '水果拼盘',
          pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
          desc: '超级好吃的甘蔗',
          price: 0,
          oldprice: 22,
          limit: 5,
          ordernum: 0,
        },
        
    },
    goodsList:[
      // {
      //   id: 'xm',
      //   classifyname: '了解项目',
      //   goods: [12, 13, 14, 15],
      // },
      {
          id:'tj',
          classifyname:'推荐',
          goods:[1,2,3,6,11],
      },
      {
        id: 'tc',
        classifyname: '套餐类',
        goods: [1,2,4,5,6,11],
      },
      {
        id: 'xc',
        classifyname: '小吃类',
        goods: [3,7,8,9,10],
      },
    ],
    cart:{
        count:0,
        total:0,
        list:{}
    },
    projects:{
      1: {
        id: 1,
        name: '60分钟飘然若仙',
        pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
        desc: '开背放松+艾灸+背颈肩按摩',
        price: 239,
        limit: 5,
        ordernum: 0,
      },
      2: {
        id: 2,
        name: '90分钟美丽佳人',
        pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
        desc: '开背放松+艾灸+背颈肩按摩',
        price: 239,
        limit: 5,
        ordernum: 0,
      },
      3: {
        id: 3,
        name: '120分钟飘然若仙',
        pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
        desc: '开背放松+艾灸+背颈肩按摩',
        price: 329,
        limit: 5,
        ordernum: 0,
      },
      4: {
        id: 4,
        name: '120分钟美丽佳人',
        pic: 'http://p1.meituan.net/208.126/deal/0246948e415300ce1bd0d7af5395d637129374.jpg',
        desc: '开背放松+艾灸+背颈肩按摩',
        price: 329,
        limit: 5,
        ordernum: 0,
      },
    },
    projectsList:[
      {
        id: 'xm',
        classifyname: '项目介绍',
        projects: [1,2,3,4],
      },
    ],
    showCartDetail:false,
    knowproject:false,

    marqueePace: 1,//滚动速度
    marqueeDistance: 0,//初始滚动距离
    marqueeDistance2: 20,
    marquee2copy_status: true,
    marquee2_margin: 120,
    size: 11,
    orientation: 'left',//滚动方向
    interval: 80 // 时间间隔

  },

  scancode:function(){
    wx.scanCode({
      onlyFromCamera: true,
      scanType: [],
      success: function(res) {
        // console.log(res);
        wx.redirectTo({
          url: res.result,
        })
      },
      fail: function(res) {},
      complete: function(res) {},
    })
  },
  //设置默认选择项
  onShow: function () {
     this.setData({
       classifySeleted: this.data.goodsList[0].id
     });

    console.log(this.data.classifySeleted);
  },
  

  //   添加购物车
  tapAddCart: function (e) {
    var id = e.target.dataset.id;
    var goods = this.data.goods[id];
    var num = this.data.cart.list[id] || 0;
    if (num < goods.limit) {
      this.addCart(id); 
    } else {
      wx.showToast({
        title: '达到限定数量了',
        image:'../../imgs/warn.png',
        duration: 2000
      })
      return false;
    }
   
   
  }, 
  //从购物车减去
  tapReduceCart:function(e){
    this.reduceCart(e.target.dataset.id); 
  },

  // 内部函数 购物车操作 获取原始信息 
  addCart:function(id){
    var num = this.data.cart.list[id] || 0;
    this.data.cart.list[id] = num+1;
    this.countCart();
   
  },
  //内部函数  ，减去商品
  reduceCart:function(id){
    var num = this.data.cart.list[id] || 0;
    if(num <= 1){
      delete this.data.cart.list[id];
    }else{
      this.data.cart.list[id] = num - 1;
    }
    
    this.countCart();
  },
  //内部函数 计算购物车数据
  countCart: function () {
    var count = 0,
      total = 0;
    for (var id in this.data.cart.list) {
      var goods = this.data.goods[id];
      count += this.data.cart.list[id];
      total += goods.price * this.data.cart.list[id];
    }
    this.data.cart.count = count;
    this.data.cart.total = total;
    //防止将购物车的商品减空之后，再次加入时出现 购物车详情
    if (count<1){
      this.setData({
        showCartDetail: false,
      });
    }
    this.setData({
      cart: this.data.cart,
      
    });
  },
  //清空购物车
  clear:function(){
    var shopcart = this;
    wx.showModal({
      title: '清空购物车？',
      content: '',
      confirmText: '清空',
      success: function (res) {
        if (res.confirm) {
          shopcart.setData({
            cart: {
              count: 0,
              total: 0,
              list: {}
            },
            showCartDetail: false,
          });
        } else if (res.cancel) {
          return false;
         
        }
      }
    })
   
   
  },
  myorder:function(){
    wx.navigateTo({
      url: '../order/order',
    })
  },
  goodsdetail:function(e){
    var id = e.currentTarget.dataset.id;
    console.log(this.data.goods[id]);
    wx.setStorageSync("good", this.data.goods[id])
    wx.setStorageSync("goods", this.data.goods)
    app.cart = this.data.cart;
    app.addr = this.data.addr;
    wx.navigateTo({
      url: '../gooddetail/gooddetail',
    })
  },

  follow: function () {
    this.setData({
      followed: !this.data.followed
    });
  },
  
  

  onGoodsScroll: function (e) {
    var kp = this.data.knowproject;
    if(!kp){
    if (e.detail.scrollTop > 10 && !this.data.scrollDown) {
      this.setData({
        scrollDown: true
      });
    } else if (e.detail.scrollTop < 10 && this.data.scrollDown) {
      this.setData({
        scrollDown: false
      });
    }

    var scale = e.detail.scrollWidth / 570,
      scrollTop = e.detail.scrollTop / scale,
      h = 0,
      classifySeleted,
      len = this.data.goodsList.length;
    this.data.goodsList.forEach(function (classify, i) {
      var _h = 70 + classify.goods.length * (46 * 3 + 20 * 2);
       if (scrollTop >= h - 100 / scale) {
      //if (scrollTop >= (h - 100 / scale)+240) {
        classifySeleted = classify.id;
      }
      h += _h;
    });
    this.setData({
      classifySeleted: classifySeleted
    });
    }
  },
  tapClassify: function (e) {
    var id = e.currentTarget.dataset.id;
    if(id!='xm'){
      this.setData({
        knowproject:false,
      })
    }else{
      this.setData({
        knowproject: true,
      })
    }
    console.log(id);
    this.setData({
      classifyViewed: id
    });
    console.log(id);
    var self = this;
    setTimeout(function () {
      self.setData({
        classifySeleted: id
      });
    }, 10);
    console.log(id);
  },
  showCartDetail: function () {
    //改进展示购物车的方法
    var num = this.data.cart.count ;
    if(num>0){
      this.setData({
        showCartDetail: !this.data.showCartDetail
      });
    }
  },
  hideCartDetail: function () {
    this.setData({
      showCartDetail: false
    });
  },
  
  selsize: function(e){
    console.log(e.currentTarget.dataset.id);
    var that =this;
    var gname = that.data.goods[e.currentTarget.dataset.id].name;

    wx.showModal({
      title: '',
      content: gname,
      showCancel:false,
      confirmText:'',
    })
  },
  
  submit:function(e){
    app.goodsList = this.data.goodsList;
    app.goods = this.data.goods;
    app.cart = this.data.cart;
    app.addr = this.data.addr;
    wx.setStorageSync("goods", this.data.goods)
    wx.navigateTo({
      url: '../commit/commit',
    })
    
  },
  
/**
 * 用户点击右上角分享
 */
  onShareAppMessage: function () {

  },

  onShow: function () {
    var vm = this;
    var length = vm.data.text.length * vm.data.size;//文字长度
    var windowWidth = wx.getSystemInfoSync().windowWidth;// 屏幕宽度
    vm.setData({
      length: length,
      windowWidth: windowWidth,
      marquee2_margin: length < windowWidth ? windowWidth - length : vm.data.marquee2_margin//当文字长度小于屏幕长度时，需要增加补白
    });
    vm.run2();// 第一个字消失后立即从右边出现
  },
  onLoad : function(){
    // var vm = this;
    // var length = vm.data.text.length * vm.data.size;//文字长度
    // var windowWidth = wx.getSystemInfoSync().windowWidth;// 屏幕宽度
    // vm.setData({
    //   length: length,
    //   windowWidth: windowWidth,
    //   marquee2_margin: length < windowWidth ? windowWidth - length : vm.data.marquee2_margin//当文字长度小于屏幕长度时，需要增加补白
    // });
    // vm.run2();// 第一个字消失后立即从右边出现
  },

  run2: function () {
    var vm = this;
    var interval = setInterval(function () {
      if (-vm.data.marqueeDistance2 < vm.data.length) {
        // 如果文字滚动到出现marquee2_margin=30px的白边，就接着显示
        vm.setData({
          marqueeDistance2: vm.data.marqueeDistance2 - vm.data.marqueePace,
          marquee2copy_status: vm.data.length + vm.data.marqueeDistance2 <= vm.data.windowWidth + vm.data.marquee2_margin,
        });
      } else {
        if (-vm.data.marqueeDistance2 >= vm.data.marquee2_margin) { // 当第二条文字滚动到最左边时
          vm.setData({
            marqueeDistance2: vm.data.marquee2_margin // 直接重新滚动
          });
          clearInterval(interval);
          vm.run2();
        } else {
          clearInterval(interval);
          vm.setData({
            marqueeDistance2: -vm.data.windowWidth
          });
          vm.run2();
       }
      }
    }, vm.data.interval);
  },

})