var app = getApp();
var common = require('../../../../common.js');
//所有卡类型
var cardType;
//当前要结账的卡
var checkoutCard;
//切换选择的卡
var selectCard;
//选择的卡下标
var selectCardIndex = 0;
//需付金额
var need = 0;
//账单门店标识，账单号
var ShopNo, BusinessNo;
Page({

  /**
   * 页面的初始数据
   */
  data: {
    //图片地址前缀
    showImgUrl: common.config.showImgUrl,
    //无会员卡图片的默认会员卡图
    cardPicUrl: common.config.cardPicUrl,
    //所有卡类型
    cardType: cardType,
    selectCardDisplay: 'display:none;'
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    var _this = this;
    var option = decodeURIComponent(options.scene);
    ShopNo = option.c;
    BusinessNo = option.b;
    // wx.showModal({
    //   title: '参数',
    //   content: decodeURIComponent(options.scene)
    // });

    // if (!options.c || !options.b) {
    //   wx.showModal({
    //     title: '提示',
    //     content: '获取账单信息失败',
    //     showCancel: false,
    //     success: function (res) {
    //       if (res.confirm) {
    //         wx.navigateBack();
    //       }
    //     }
    //   });
    // } else {
    //   //获取账单信息
    //   wx.request({
    //     url: common.config.host + '/index.php/Api/Base/getCustomItem',
    //     data: {
    //       'authorizerId': app.globalData.authorizerId,
    //       'openid': openid,
    //       'type': 2
    //     },
    //     method: 'POST',
    //     header: {
    //       'content-type': 'application/json'
    //     },
    //     success: function (res) {
    //       wx.hideLoading();
    //       if (res.statusCode == 200) {
    //         if (res.data.status == 1) {
    //           if (res.data.info == '') {
    //             wx.showModal({
    //               title: '提示',
    //               content: '获取账单信息失败',
    //               showCancel: false,
    //               success: function (res) {
    //                 if (res.confirm) {
    //                   wx.navigateBack();
    //                 }
    //               }
    //             });
    //           } else {

    //           }
    //         } else {
    //           wx.showModal({
    //             title: '提示',
    //             content: res.data.info,
    //             showCancel: false
    //           });
    //         }
    //       } else {
    //         wx.showModal({
    //           title: '提示',
    //           content: '请求失败，服务器错误',
    //           showCancel: false
    //         });
    //       }
    //     }
    //   });
    // }

    _this.getOpenCardType().then(function(data){
      //过滤无效会员卡
      if (data.info.length > 1){
        cardType = [];
        for (var i = 0; i < data.info.length; i++) {
          if (data.info[i].CardState == 0){
            cardType.push(data.info[i]);
          }
        }
      }else{
        cardType = data.info;
      }

      if (cardType.length == 0){
        wx.showModal({
          title: '提示',
          content: '会员卡非正常状态，无法结账',
          showCancel: false,
          success: function (res) {
            if (res.confirm) {
              wx.navigateBack();
            }
          }
        });
        return false;
      }

      //充值金额与充值赠送金额合计成余额
      for (var i = 0; i < cardType.length; i++) {
        cardType[i]['Balance'] = (parseFloat(cardType[i].CardNum) + parseFloat(cardType[i].SendNum));
      }

      checkoutCard = cardType[0];
      selectCard = cardType[0];

      //查询账单信息
      _this.getBillingInfo(checkoutCard, option.c, option.b).then(function (data) {

        _this.setData({
          BillingInfo: data.info,
          BusinessNo: '201804270010',
          need: data.need
        });

      }).catch(function(data){
        wx.showModal({
          title: '提示',
          content: data,
          showCancel: false,
          success: function(res){
            if (res.confirm){
              wx.navigateBack();
            }
          }
        });
        return false;
      });

      _this.setData({
        cardType: cardType,
        checkoutCard: checkoutCard,
        selectCard: selectCard
      });
    });

  },

  /**
   * 获取当前用户所有卡类型
   */
  getOpenCardType: function () {
    var p = new Promise(function (resolve, reject) {
      var openid = wx.getStorageSync('openid')
        , _this = this;

      wx.request({
        url: common.config.host + '/index.php/Api/Base/getVipCard',
        data: {
          'authorizerId': app.globalData.authorizerId,
          'openid': openid,
          'type': 2
        },
        method: 'POST',
        header: {
          'content-type': 'application/json'
        },
        success: function (res) {
          wx.hideLoading();
          if (res.statusCode == 200) {
            if (res.data.status == 1) {
              if (res.data.info == '') {
                wx.showModal({
                  title: '提示',
                  content: '您还没有会员卡，现在去办卡',
                  success: function (e) {
                    if (e.confirm) {
                      wx.redirectTo({
                        url: '../docard/docard?id=3',
                      });
                    } else if (e.cancel) {
                      wx.navigateBack();
                    }
                  }
                });
              } else {
                resolve(res.data);
              }
            } else {
              wx.showModal({
                title: '提示',
                content: res.data.info,
                showCancel: false
              });
            }
          } else {
            wx.showModal({
              title: '提示',
              content: '请求失败，服务器错误',
              showCancel: false
            });
          }
        }
      });
    });
    return p;
  },

  /**
   * 切换选卡事件
   */
  bindChange: function (e) {
    const val = e.detail.value;
    selectCardIndex = val[0];

    this.setData({
      selectCard: cardType[val[0]]
    });
  },

  /**
   * 点击选卡
   */
  switching: function () {
    this.setData({
      selectCardDisplay: 'display:block;'
    });
  },

  /**
   * 点击关闭选卡
   */
  closeSelectCard: function () {
    this.setData({
      selectCardDisplay: 'display:none;'
    });
  },

  /**
   * 确定选卡
   */
  carry: function () {
    var _this = this;
    checkoutCard = cardType[selectCardIndex];

    this.setData({
      selectCardDisplay: 'display:none;',
      checkoutCard: checkoutCard
    });
  },

  /**
   * 确定付款
   */
  nowPay: function () {
    console.log(checkoutCard);
  },

  /**
   * 获取账单信息
   */
  getBillingInfo: function (checkoutCard, shopNo, businessNo){
    var p = new Promise(function (resolve, reject) {
      var openid = wx.getStorageSync('openid');
      wx.request({
        url: common.config.host + '/index.php/Api/Base/getBillingInfo',
        data: {
          'authorizerId': app.globalData.authorizerId,
          'openid': openid,
          'checkoutCard': checkoutCard,
          'shopNo': 'TLM02',
          'businessNo': '201804270010'
        },
        method: 'POST',
        header: {
          'content-type': 'application/json'
        },
        success: function (res) {
          wx.hideLoading();
          if (res.statusCode == 200) {
            if (res.data.status == 1) {
              if (res.data.info == '') {
                reject('没有查询到账单信息');
              } else {
                resolve(res.data);
              }
            } else {
              reject(res.data.info);
            }
          } else {
            reject('请求失败，服务器错误');
          }
        }
      });
    });
    return p;
  }
})