//输入公用配置参数
let common = require('../../../../common.js');
//获取APP
let app = getApp();
//当前要充值的会员卡
var rechargeCard;
//充值规则
var recharRules = [];
//选中的充值金额
var am = 0;
//赠送金额
var gift = 0;
//推销员工号
var salesStaff;
Page({

  /**
   * 页面的初始数据
   */
  data: {
    amountIdx: 0,
    //当前要充值的会员卡
    rechargeCard: rechargeCard
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    var cardno = options.cardno;
    var shopno = options.shopno;
    //获取当前用户的所有会员卡
    wx.showLoading({
      title: '加载中',
      mask: true
    });

    var openid = wx.getStorageSync('openid')
      , _this = this;

    wx.request({
      url: common.config.host + '/index.php/Api/Base/getVipCard',
      data: {
        'authorizerId': app.globalData.authorizerId,
        'openid': openid,
        'type': 2
      },
      method: 'POST',
      header: {
        'content-type': 'application/json'
      },
      success: function (res) {
        wx.hideLoading();
        if (res.statusCode == 200) {
          if (res.data.status == 1) {
            if (res.data.info == '') {
              wx.showModal({
                title: '提示',
                content: '无会员卡类型',
                showCancel: false
              });
            } else {
              
              for (var i = 0; i < res.data.info.length; i++) {
                if (res.data.info[i].CardNo == cardno && res.data.info[i].ShopNo == shopno) {
                  rechargeCard = res.data.info[i];
                }
              }

              //卡状态是否正常
              if (rechargeCard.CardState != 0){
                var CardStateMsg = '';
                switch (rechargeCard.CardState){
                  case 1:
                    CardStateMsg = '会员卡已锁定';
                    break;
                  case 2:
                    CardStateMsg = '会员卡已挂失';
                    break;
                }
                wx.showModal({
                  title: '提示',
                  content: CardStateMsg,
                  showCancel: false,
                  success: function(res){
                    if(res.confirm){
                      wx.navigateBack();
                    }
                  }
                });
                return false;
              }

              rechargeCard['names'] = res.data.names;
              rechargeCard['phone'] = res.data.phone;
              rechargeCard['Balance'] = (parseFloat(rechargeCard.CardNum) + parseFloat(rechargeCard.SendNum));
              
              //获取充值规则
              var ruleArr = [];
              var rule = rechargeCard.rules.split(';');
              for (var i = 0; i < rule.length; i++) {
                ruleArr.push({
                  'am': rule[i].split('=')[0],
                  'gift': rule[i].split('=')[1]
                });
              }

              //当前选中的充值金额
              am = ruleArr[0]['am'];
              gift = ruleArr[0]['gift'];

              _this.setData({
                rechargeCard: rechargeCard,
                recharRules: ruleArr
              });

            }
          } else {
            wx.showModal({
              title: '提示',
              content: res.data.info,
              showCancel: false
            });
          }
        } else {
          wx.showModal({
            title: '提示',
            content: '请求失败，服务器错误',
            showCancel: false
          });
        }
      }
    });
    
    //推销员工号
    salesStaff = '';
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },
  /**
   * 点击切换金额
   */
  changeAmount: function (e) {
    am = e.target.dataset.am;
    gift = e.target.dataset.gift;

    this.setData({
      amountIdx: e.target.dataset.idx
    });
  },

  /**
   * 点击提交按钮
   */
  handleCard: function (e) {
    //是否达到续费标准(金额)
    if (parseFloat(am) < parseFloat(rechargeCard.ReNewLevel)) {
      wx.showModal({
        title: '提示',
        content: '续费金额未达到续费标准金额，此卡续费标准金额为' + rechargeCard.ReNewLevel + '元',
        showCancel: false
      });
      return false;
    }
    
    wx.showLoading({
      title: '加载中',
      mask: true
    });

    var formId = e.detail.formId;
    var openid = wx.getStorageSync('openid');
    
    wx.request({
      url: common.config.host + '/index.php/Api/Requestdata/rechargeUniformOrders',
      data: {
        'authorizerId': app.globalData.authorizerId,
        'openid': openid,
        'rAmount': am,
        'gAmount': gift,
        'formId': formId,
        'rechargeCard': rechargeCard,
        'userInfo': {
          'staffNo': salesStaff.trim()
        }
      },
      method: 'POST',
      header: {
        'content-type': 'application/json'
      },
      success: function (res) {
        wx.hideLoading();
        var info = res.data.info;
        if (res.statusCode == 200) {
          if (res.data.status == 1) {
            wx.requestPayment({
              timeStamp: info.timeStamp,
              nonceStr: info.nonceStr,
              package: info.package,
              signType: info.signType,
              paySign: info.paySign,
              success: function (res) {
                console.log(res);
                if (res.errMsg == 'requestPayment:ok') {
                  //保存prepay_id用于发送小程序模版信息
                  common.savePrepayId(app.globalData.authorizerId, openid, info.package);
                  wx.showToast({
                    title: '支付成功',
                    mask: true
                  });
                }
              },
              fail: function (res) {
                if (res.errMsg == 'requestPayment:fail cancel') {
                  wx.showToast({
                    title: '支付已取消',
                    mask: true
                  });
                } else {
                  wx.showModal({
                    title: '提示',
                    content: res.errMsg,
                    showCancel: false
                  });
                }
              }
            });
          } else {
            wx.showModal({
              title: '提示',
              content: info,
              showCancel: false
            });
          }
        } else {
          wx.showModal({
            title: '提示',
            content: info,
            showCancel: false
          });
        }
      }
    });
  },

  /**
   * 监听输入的推销员工号
   */
  salesStaff: function (e) {
    salesStaff = e.detail.value;
  }
})