var app = getApp();
//获取全局配置
var common = require('../../../../common.js');

Page({

  /**
   * 页面的初始数据
   */
  data: {
    orderType: [
      'E团购',
      '自助点单',
      '约技师',
      '订房间',
      '约项目',
      '在线商场',
      '在线办卡',
      '在线充值'
    ],
    orderState: [
      '全部',
      '待使用',
      '待评价',
      '已完成'
    ],
    tname: '分类订单',
    //图片地址前缀
    showImgUrl: common.config.showImgUrl,
    //无会员卡图片的默认会员卡图
    cardPicUrl: common.config.cardPicUrl
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    let _this = this;
    _this.checkingOrder(0).then(function (data){
      if(data.info.length > 0){
        _this.setData({
          orderData: data.info
        });
      }else{
        wx.showModal({
          title: '提示',
          content: '没有查询到订单信息',
          showCancel: false
        });
      }
    }).catch(function(data){
      wx.showModal({
        title: '提示',
        content: data,
        showCancel: false
      });
    });
  },

  /**
   * 点击切换全部订单和分类订单
   */
  orderTypeTitleChange: function(ev){
    var idx = ev.currentTarget.dataset.idx;
    if (idx == 1){
      this.setData({
        typeOrderDisplay: 'display:none',
        tIdx: idx,
        tname: '分类订单'
      });
    }else{
      this.setData({
        typeOrderDisplay: 'display:block',
        tIdx: idx
      });
    }
  },

  /**
   * 点击切换分类订单类型
   */
  orderTypeChange: function(ev){
    wx.showLoading({
      title: '加载中',
      mask: true
    });
    var tname = ev.currentTarget.dataset.tname;
    this.setData({
      typeOrderDisplay: 'display:none',
      tIdx: 2,
      tname: tname
    });

    setTimeout(function(){
      wx.hideLoading();
    },500);
  },

  /**
   * 点击切换订单状态
   */
  orderStateChange: function(ev){
    var idx = ev.currentTarget.dataset.idx;

    this.setData({
      sIdx: idx
    });
  },

  /**
   * 点击立即消费
   */
  lijixiaofei: function(){
    this.setData({
      qrDisplay: 'display:block'
    });
  },

  /**
   * 关闭二维码
   */
  closeQrcode: function () {
    this.setData({
      qrDisplay: 'display:none'
    });
  },

  /**
   * 点击评价，跳转至评价页
   */
  evaluation: function(){
    wx.navigateTo({
      url: '/pages/transbuy/pages/assess/assess',
    });
  },

  /**
   * 跳转至订单详情页
   */
  toOrderDetail: function(e){
    var guid = e.currentTarget.dataset.guid;
    wx.navigateTo({
      url: '../orderdetail/orderdetail?type=1&guid=' + guid,
    });
  },

  /**
   * 查询订单
   * @param   orderType   订单类型。 0所有类型订单
   */
  checkingOrder:function(orderType){
    var p = new Promise(function (resolve, reject) {
      var openid = wx.getStorageSync('openid');

      wx.request({
        url: common.config.host + '/index.php/Api/Requestdata/getUserOrder',
        data: {
          'authorizerId': app.globalData.authorizerId,
          'openid': openid
        },
        method: 'POST',
        header: {
          'content-type': 'application/json'
        },
        success: function (res) {
          //返回成功
          if (res.statusCode == 200) {
            if (res.data.status == 1) {
              console.log(res.data);
              resolve(res.data);
            } else {
              reject(res.data.info);
            }

          } else {
            reject('请求失败');
          }
        }
      });
    });
    return p;
  }
})