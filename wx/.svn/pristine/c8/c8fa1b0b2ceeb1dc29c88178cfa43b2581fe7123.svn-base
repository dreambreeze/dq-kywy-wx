var app = getApp();
var common = require('../../../../common.js');
var height = 0,
  dcH = 0,
  dcStoreList = [],
  cardType = [],
  cardTypeData = [];
//门店电话和地址
var shopInfo = {};
//用户姓名/手机号
var names, phone;
var storesortTime = null;
Page({

  /**
   * 页面的初始数据
   */
  data: {
    dcStore: dcStoreList,
    storeIdx: 0,
    showMask: false,
    //图片地址前缀
    showImgUrl: common.config.showImgUrl,
    //无会员卡图片的默认会员卡图
    cardPicUrl: common.config.cardPicUrl,
    //所有卡类型
    cardType: cardType,
    //门店电话和地址
    shopInfo: shopInfo
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    var _this = this;
    if (wx.canIUse('createSelectorQuery')) {
      var query = wx.createSelectorQuery();
      query.select('.dc-title').boundingClientRect(function (res) {
        dcH = res.height;
      }).exec();

      setTimeout(function () {
        wx.getSystemInfo({
          success: function (res) {
            height = res.windowHeight - dcH;
            _this.setData({
              height: height
            });
          }
        });
      }, 1000);
    }

    this.getOpenCardType();
  },
  /**
   * 点击切换门店会员卡
   */
  changeStore: function (e) {
    //获取门店电话和地址
    shopInfo = {
      shoptel: cardTypeData[dcStoreList[e.target.dataset.index]][0].shoptel,
      address: cardTypeData[dcStoreList[e.target.dataset.index]][0].address,
      storename: dcStoreList[e.target.dataset.index]
    }

    for (var i = 0; i < cardTypeData[dcStoreList[e.target.dataset.index]].length; i++) {
      cardTypeData[dcStoreList[e.target.dataset.index]][i]['Balance'] = (parseFloat(cardTypeData[dcStoreList[e.target.dataset.index]][i].CardNum) + parseFloat(cardTypeData[dcStoreList[e.target.dataset.index]][i].SendNum));
    }

    this.setData({
      storeIdx: e.target.dataset.index,
      cardType: cardTypeData[dcStoreList[e.target.dataset.index]],
      //获取门店电话和地址
      shopInfo: shopInfo
    });
  },

  /**
   * 获取当前用户所有卡类型
   */
  getOpenCardType: function () {
    wx.showLoading({
      title: '加载中',
      mask: true
    });
    var openid = wx.getStorageSync('openid')
      , _this = this;

    wx.request({
      url: common.config.host + '/index.php/Api/Base/getVipCard',
      data: {
        'authorizerId': app.globalData.authorizerId,
        'openid': openid,
        'type': 2,
        'isstoresort': 1
      },
      method: 'POST',
      header: {
        'content-type': 'application/json'
      },
      success: function (res) {
        if (res.statusCode == 200) {
          if (res.data.status == 1) {
            if (res.data.info == '') {
              wx.showModal({
                title: '提示',
                content: '您还没有会员卡，现在去办卡',
                success: function (e) {
                  if (e.confirm) {
                    wx.redirectTo({
                      url: '../docard/docard?id=3',
                    });
                  } else if (e.cancel) {
                    wx.navigateBack();
                  }
                }
              });
            } else {
              //获取会员卡数据以切换门店使用
              cardTypeData = res.data.info;
              
              //如果只有一个门店，就不需要获取定位距离最近的门店展示在最前面
              if (Object.keys(cardTypeData).length > 1){
                //获取门店地址
                var addressArr = [];
                for (var item in cardTypeData) {
                  addressArr.push({
                    'address': cardTypeData[item][0].address,
                    'distance': 0,
                    'storename': item
                  });
                }

                var k = [];

                //计算门店距离
                for (let i = 0; i < addressArr.length; i++) {
                  common.geocoder(addressArr[i].address).then(function (data) {
                    common.calculateDistance([data]).then(function (data) {
                      addressArr[i]['distance'] = data;
                      k.push(1);
                    }).catch(function (data) {
                      addressArr[i]['distance'] = 65535;
                      k.push(2);
                    });
                  }).catch(function (data) {
                    addressArr[i]['distance'] = 65535;
                    k.push(3);
                  });
                }

                //定时检查定位计算距离是否有返回，已返回清除定时器
                clearInterval(storesortTime);
                storesortTime = setInterval(function () {
                  if (k.length == addressArr.length) {
                    clearInterval(storesortTime);
                    wx.hideLoading();

                    //以距离最近的门店排序
                    addressArr = addressArr.sort(common.compare('distance'));

                    //获取门店列表
                    dcStoreList = [];
                    for (let i = 0; i < addressArr.length; i++) {
                      dcStoreList.push(addressArr[i].storename);
                    }


                    //获取门店电话和地址
                    shopInfo = {
                      shoptel: cardTypeData[addressArr[0].storename][0].shoptel,
                      address: cardTypeData[addressArr[0].storename][0].address,
                      storename: dcStoreList[0]
                    }
                    //充值金额与赠送金额合计成余额
                    for (var i = 0; i < cardTypeData[addressArr[0].storename].length; i++) {
                      cardTypeData[addressArr[0].storename][i]['Balance'] = (parseFloat(cardTypeData[addressArr[0].storename][i].CardNum) + parseFloat(cardTypeData[addressArr[0].storename][i].SendNum));
                    }

                    //用户姓名与手机号
                    names = res.data.names;
                    phone = res.data.phone;

                    _this.setData({
                      dcStore: dcStoreList,
                      cardType: cardTypeData[addressArr[0].storename],
                      shopInfo: shopInfo
                    });

                  }
                }, 1200);
              }else{
                wx.hideLoading();
                //获取门店列表
                dcStoreList = [];
                for (var item in cardTypeData) {
                  dcStoreList.push(item);
                }


                //获取门店电话和地址
                shopInfo = {
                  shoptel: cardTypeData[dcStoreList[0]][0].shoptel,
                  address: cardTypeData[dcStoreList[0]][0].address,
                  storename: dcStoreList[0]
                }
                //充值金额与赠送金额合计成余额
                for (var i = 0; i < cardTypeData[dcStoreList[0]].length; i++) {
                  cardTypeData[dcStoreList[0]][i]['Balance'] = (parseFloat(cardTypeData[dcStoreList[0]][i].CardNum) + parseFloat(cardTypeData[dcStoreList[0]][i].SendNum));
                }

                //用户姓名与手机号
                names = res.data.names;
                phone = res.data.phone;

                _this.setData({
                  dcStore: dcStoreList,
                  cardType: cardTypeData[dcStoreList[0]],
                  shopInfo: shopInfo
                });
              }
            }
          } else {
            wx.hideLoading();
            wx.showModal({
              title: '提示',
              content: res.data.info,
              showCancel: false
            });
          }
        } else {
          wx.hideLoading();
          wx.showModal({
            title: '提示',
            content: '请求失败，服务器错误',
            showCancel: false
          });
        }
      }
    });
  },

  /**
   * 点击跳转至充值
   */
  jumpurl: function (e) {
    wx.navigateTo({
      url: e.currentTarget.dataset.url,
    });
  }
})