var app = getApp();
Page({

  /**
   * 页面的初始数据
   */
  data: {
    pic: 'https://iservice.daqisoft.cn/Public/Home/images/amimgs/pic.png',
    cartimg: 'https://iservice.daqisoft.cn/Public/Home/images/amimgs/cart.png',
    toright: 'https://iservice.daqisoft.cn/Public/Home/images/amimgs/toright.png',
    startgray:'',
    addimg: '',
    reduceimg: '',
    good:{},
    goods:{},
    cart:{},
    showCartDetail: false,
  },
  onLoad:function(options){
    this.setData({
      good: wx.getStorageSync("good"),
      goods: wx.getStorageSync("goods"),
      cart: app.cart,
      addimg: app.globalData.addimg,
      reduceimg: app.globalData.reduceimg
    })
  },
  

  // 加购物车操作
  //   添加购物车
  tapAddCart: function (e) {
    var id = e.target.dataset.id;
    var goods = this.data.goods[id];
    var num = this.data.cart.list[id] || 0;
    if (num < goods.limit) {
      this.addCart(id);
    } else {
      wx.showToast({
        title: '达到限定数量了',
        image: '../../imgs/warn.png',
        duration: 2000
      })
      return false;
    }


  },
  //从购物车减去
  tapReduceCart: function (e) {
    this.reduceCart(e.target.dataset.id);
  },

  // 内部函数 购物车操作 获取原始信息 
  addCart: function (id) {
    var num = this.data.cart.list[id] || 0;
    this.data.cart.list[id] = num + 1;
    this.countCart();

  },
  //内部函数  ，减去商品
  reduceCart: function (id) {
    var num = this.data.cart.list[id] || 0;
    if (num <= 1) {
      delete this.data.cart.list[id];
    } else {
      this.data.cart.list[id] = num - 1;
      //console.log(this.data.cart.list[id]);
    }

    this.countCart();
  },
  //内部函数 计算购物车数据
  countCart: function () {
    var count = 0,
      total = 0;
    for (var id in this.data.cart.list) {
      var goods = this.data.goods[id];
      count += this.data.cart.list[id];
      total += goods.price * this.data.cart.list[id];
    }
    this.data.cart.count = count;
    this.data.cart.total = total;
    //防止将购物车的商品减空之后，再次加入时出现 购物车详情
    if (count < 1) {
      this.setData({
        showCartDetail: false,
      });
    }
    this.setData({
      cart: this.data.cart,

    });
  },
  //清空购物车
  clear: function () {
    var shopcart = this;
    wx.showModal({
      title: '清空购物车？',
      content: '',
      confirmText: '清空',
      success: function (res) {
        if (res.confirm) {
          shopcart.setData({
            cart: {
              count: 0,
              total: 0,
              list: {}
            },
            showCartDetail: false,
          });
        } else if (res.cancel) {
          return false;

        }
      }
    })
  },
  showCartDetail: function () {
    //改进展示购物车的方法
    var num = this.data.cart.count;
    if (num > 0) {
      this.setData({
        showCartDetail: !this.data.showCartDetail
      });
    }
  },
  hideCartDetail: function () {
    this.setData({
      showCartDetail: false
    });
  },

  submit: function (e) {
    app.goodsList = this.data.goodsList;
    app.goods = this.data.goods;
    app.cart = this.data.cart;
    var addr = this.data.addr;
    wx.navigateTo({
      url: '../commit/commit?addr=' + addr,
    })

  },
  onUnload:function(){
    var pages = getCurrentPages();
    var prevPage = pages[pages.length - 2];  //上一个页面
    prevPage.setData({
      cart: this.data.cart,
    })
  }
 

})